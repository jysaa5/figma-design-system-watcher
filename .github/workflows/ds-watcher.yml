name: DS Watcher (Email)

on:
  schedule: 
    - cron: "*/5 * * * *"   # 5Î∂ÑÎßàÎã§ Ïã§Ìñâ (UTC)
  workflow_dispatch:        # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

concurrency:
  group: ds-watcher
  cancel-in-progress: false

jobs:
  watch:
    runs-on: ubuntu-latest
    timeout-minutes: 10     # 10Î∂Ñ ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï
    permissions:
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1    # ÏµúÏã† Ïª§Î∞ãÎßå Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÜçÎèÑ Ìñ•ÏÉÅ)

      # üîß ÏàòÏ†ï: pnpmÏùÑ Î®ºÏ†Ä ÏÑ§Ïπò
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.12.0'  # ÏïàÏ†ïÏ†ÅÏù∏ Î≤ÑÏ†Ñ ÏÇ¨Ïö©
          run_install: false # ÏàòÎèôÏúºÎ°ú ÏÑ§ÏπòÌï† ÏòàÏ†ï

      # üîß ÏàòÏ†ï: pnpm ÏÑ§Ïπò ÌõÑ Node.js ÏÑ§Ï†ï (Ï∫êÏãú Ìè¨Ìï®)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'     # Ïù¥Ï†ú pnpmÏù¥ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏùå

      - name: Verify environment
        run: |
          echo "Node version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"
          echo "Working directory: $(pwd)"
          echo "Current user: $(whoami)"

      - name: Install dependencies
        run: |
          # pnpm-lock.yamlÏù¥ ÏûàÏúºÎ©¥ frozen-lockfile ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏùºÎ∞ò ÏÑ§Ïπò
          if [ -f pnpm-lock.yaml ]; then
            echo "Found pnpm-lock.yaml, using frozen lockfile"
            pnpm install --frozen-lockfile
          else
            echo "No pnpm-lock.yaml found, installing normally"
            pnpm install
          fi

      - name: Verify installation
        run: |
          echo "Installed packages:"
          pnpm list --depth 0 || echo "Failed to list packages"
          echo ""
          echo "Project structure:"
          ls -la
          echo ""
          if [ -d "scripts" ]; then
            echo "Scripts directory:"
            ls -la scripts/
          fi

      - name: Check package.json scripts
        run: |
          echo "Available scripts:"
          if command -v jq &> /dev/null; then
            cat package.json | jq '.scripts'
          else
            echo "Scripts section from package.json:"
            grep -A 10 '"scripts"' package.json || echo "No scripts found"
          fi

      - name: Run DS Watcher
        run: |
          echo "Starting DS Watcher..."
          pnpm run run:once
        env:
          # Figma ÏÑ§Ï†ï
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          
          # SMTP ÏÑ§Ï†ï
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          
          # Î©îÏùº ÏÑ§Ï†ï
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          MAIL_SUBJECT_PREFIX: ${{ secrets.MAIL_SUBJECT_PREFIX }}
          
          # Ï∂îÍ∞Ä ÌôòÍ≤Ω Î≥ÄÏàò (ÌïÑÏöîÏãú)
          NODE_ENV: production
          TZ: Asia/Seoul

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: watcher-logs-${{ github.run_number }}
          path: |
            *.log
            logs/
            .next/
          retention-days: 7

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå DS Watcher failed at $(date)"
          echo "Run ID: ${{ github.run_id }}"
          echo "Commit: ${{ github.sha }}"